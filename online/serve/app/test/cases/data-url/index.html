<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <link rel="stylesheet" href="../../vzome-viewer.css">
    <title>Viewers with data URLs</title>
    <script id="template" type="text/xmldata">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<vzome:vZome xmlns:vzome="http://xml.vzome.com/vZome/4.0.0/" buildNumber="116" field="golden" version="7.1">
  <EditHistory editNumber="12" lastStickyEdit="5">
    <StrutCreation anchor="0 0 0 0 0 0" dir="green" index="0" len="2 2"/>
    <AdjustSelectionByClass balls="IGNORE" originLast="true" panels="IGNORE" struts="SELECT"/>
    <Midpoint/>
    <SelectManifestation point="0 0 0 0 0 0"/>
    <TranslationTool name="tool-0"/>
    <SelectAll originLast="true"/>
    <ApplyTool copyColors="true" deleteInputs="true" name="tool-0"/>
    <BeginBlock/>
    <DeselectAll/>
    <SelectManifestation point="0 0 0 0 0 0"/>
    <EndBlock/>
    <Delete/>
  </EditHistory>
  <notes/>
  <sceneModel ambientLight="41,41,41" background="175,200,220">
    <directionalLight color="235,235,228" x="1.0" y="-1.0" z="-1.0"/>
    <directionalLight color="228,228,235" x="-1.0" y="0.0" z="0.0"/>
    <directionalLight color="30,30,30" x="0.0" y="0.0" z="-1.0"/>
  </sceneModel>
  <Viewing>
    <ViewModel distance="75.0" far="150.0" near="0.1899999976158142" parallel="false" stereoAngle="0.0" width="35.0">
      <LookAtPoint x="0.0" y="0.0" z="0.0"/>
      <UpDirection x="-0.40824830532073975" y="0.8164966106414795" z="-0.40824830532073975"/>
      <LookDirection x="-0.5773502588272095" y="-0.5773502588272095" z="-0.5773502588272095"/>
    </ViewModel>
  </Viewing>
  <SymmetrySystem name="icosahedral" renderingStyle="lifelike">
    <Direction color="0,142,194" name="blue" orbit="[[0,0,1],[0,0,1]]"/>
    <Direction color="0,153,63" name="green" orbit="[[2,-1,1],[5,-3,1]]"/>
    <Direction color="154,117,74" name="sand" orbit="[[-8,5,1],[5,-3,1]]"/>
    <Direction color="18,73,48" name="spruce" orbit="[[-5,4,11],[-5,4,11]]"/>
    <Direction color="217,18,24" name="red" orbit="[[-1,1,1],[0,0,1]]"/>
    <Direction color="255,126,106" name="coral" orbit="[[-3,2,2],[-1,1,2]]"/>
    <Direction color="50,50,50" name="black" orbit="[[-2,3,11],[-7,5,11]]"/>
    <Direction color="117,0,50" name="maroon" orbit="[[5,-3,1],[0,0,1]]"/>
    <Direction color="255,179,26" name="yellow" orbit="[[0,0,1],[2,-1,1]]"/>
    <Direction color="239,245,61" name="sulfur" orbit="[[-1,1,3],[0,0,1]]"/>
    <Direction color="255,51,143" name="rose" orbit="[[0,0,1],[-4,3,5]]"/>
    <Direction color="0,179,161" name="turquoise" orbit="[[2,-1,2],[-3,2,2]]"/>
    <Direction color="116,195,0" name="apple" orbit="[[2,-1,3],[-1,1,3]]"/>
    <Direction color="136,37,0" name="cinnamon" orbit="[[5,-3,2],[2,-1,2]]"/>
    <Direction color="125,54,211" name="purple" orbit="[[2,-1,1],[0,0,1]]"/>
    <Direction color="235,82,0" name="orange" orbit="[[-4,3,5],[3,-1,5]]"/>
    <Direction color="0,0,153" name="navy" orbit="[[-1,1,2],[2,-1,2]]"/>
    <Direction color="107,53,26" name="brown" orbit="[[2,-1,3],[5,-3,3]]"/>
    <Direction color="175,135,255" name="lavender" orbit="[[-3,2,1],[-3,2,1]]"/>
    <Direction color="100,113,0" name="olive" orbit="[[3,-1,5],[0,0,1]]"/>
  </SymmetrySystem>
  <OtherSymmetries>
    <SymmetrySystem name="octahedral" renderingStyle="trapezoids">
      <Direction color="0,142,194" name="blue" orbit="[[0,0,1],[0,0,1]]"/>
      <Direction color="175,135,255" name="lavender" orbit="[[1,2,1],[-1,0,1]]"/>
      <Direction color="0,179,161" name="turquoise" orbit="[[-1,2,1],[1,-2,1]]"/>
      <Direction color="50,50,50" name="black" orbit="[[0,1,1],[1,-1,1]]"/>
      <Direction color="0,153,63" name="green" orbit="[[0,0,1],[-1,0,1]]"/>
      <Direction color="100,113,0" name="olive" orbit="[[1,0,1],[3,-2,1]]"/>
      <Direction color="117,0,50" name="maroon" orbit="[[-1,2,1],[1,0,1]]"/>
      <Direction color="107,53,26" name="brown" orbit="[[1,0,1],[-2,0,1]]"/>
      <Direction color="255,179,26" name="yellow" orbit="[[1,0,1],[-1,0,1]]"/>
      <Direction color="217,18,24" name="red" orbit="[[-1,1,1],[0,0,1]]"/>
      <Direction color="125,54,211" name="purple" orbit="[[0,0,1],[2,-1,1]]"/>
    </SymmetrySystem>
  </OtherSymmetries>
  <Tools>
    <Tool copyColors="true" deleteInputs="true" id="tool-0" label="translation 0" selectInputs="false"/>
  </Tools>
</vzome:vZome>
    </script>
    <script type="module" src="/modules/vzome-viewer.js"></script>
    <script>
      window.addEventListener("load", () => {
        // We could trim() the template here so the SAX parser in desktop vZome 
        // doesn't choke on leading whitespace
        // but since I've now done the trimming in the downloadVZome() method of export.jsx,
        // I'll specifically introduce some leading whitespace here 
        // to ensure that it gets removed before it's downloaded.
        // The viewer is not so picky, so it works fine with leading whitespace.
        const template = "\n  \t  " + document.getElementById("template").textContent //.trim()
        const filename = "Data-URL-download-green.vZome"
        // defer the call to loadFromText()
        setTimeout( () => {
          const viewer = document.getElementById("text-viewer")
          // Older versions of the viewer didn't return a promise.
          // We use Promise.resolve rather than await
          // so we can be sure there is a .then() method
          // when using this code with older versions of the viewer.
          Promise.resolve(viewer.loadFromText(filename, template))
            .then(results => {
              if(results !== undefined) {
                console.log(results)
              }
              if(viewer.reactive == 'false') {
                viewer.update({camera:true})
              }
            })
            .catch(error => {
              console.error(error)
              alert(error)
            })
        }, 10000) // Give API enough time to load since we don't (yet) have any way to know for sure.

        // The viewer expects the filename to be at the very end of the URL 
        // and to begin with "/" so we'll append the filename to the encoded data URL
        // using the 'hitchhiker' method (after the #/).
        const mimeType = "text/plain"
        const fileNameUrlSuffix = `#/${encodeURIComponent(filename)}`
        {
          const name = fileNameUrlSuffix.replace("green", "yellow")
          const base64Url = `data:${mimeType};base64,${btoa(template.replace("green", "yellow"))}${name}`
          setViewerSource("base64-viewer", base64Url)
        }
        {
          const name = fileNameUrlSuffix.replace("green", "red")
          const rawUrl = `data:${mimeType};charset=utf-8,${encodeURIComponent(template.replace("green", "red"))}${name}`
          setViewerSource("uri-viewer", rawUrl)
        }
      })

      function setViewerSource(viewerId, source) {
        const viewer = document.getElementById(viewerId)
        viewer.src = source
        if(viewer.reactive == 'false') {
          setTimeout(viewer.update({camera:false}), 1000)
        }
      }
    </script>
    <style>
      section {
        width: 400px;
        height: 300px;
      }
      p {
        background-color: white;
        padding: 1ch;
      }
    </style>
  </head>
  <body>
    <article>
      <p>
        <ul>
          <li>References vZome XML data stored within the HTML DOM</li>
          <li>Invokes loadFromText() with leading whitespace to ensure it's trimmed</li>
          <li>Modifies the green strut in the template to red or yellow strut models</li>
          <li>Sets viewer.src to either URI encoded or base64 encoded data URL </li>
          <li>Works with the viewer's 'reactive' attribute set to either true or false</li>
          <li>Includes a filename to be used by the viewer's download functionality</li>
          <li></li>
          <li>YOU must manually download the vZome files to verify that desktop can open them.</li>
        </ul>
      </p>
      <section>
        <vzome-viewer id="text-viewer" reactive="false"></vzome-viewer>
        <p>green strut, unencoded data using loadFromText()</p>
      </section>
      <section>
        <vzome-viewer id="base64-viewer" reactive="false"></vzome-viewer>
        <p>yellow strut, base64 encoded data</p>
      </section>
      <section>
        <vzome-viewer id="uri-viewer"></vzome-viewer>
        <p>red strut, URI encoded data</p>
      </section>
    </article>
  </body>
</html>
